<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MessFlow</title>

    <!-- First-time user redirect -->
    <script>
        if (!localStorage.getItem('mess_user_onboarded')) {
            window.location.replace('welcome.html');
        }
    </script>

    <!-- iOS Design System CSS -->
    <link rel="stylesheet" href="mobile.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sf': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        'ios-blue': '#007AFF',
                        'ios-green': '#34C759',
                        'ios-red': '#FF3B30',
                        'ios-orange': '#FF9500',
                        'ios-purple': '#AF52DE',
                        'ios-gray': '#8E8E93',
                        'ios-bg': '#F2F2F7',
                    }
                }
            }
        }
    </script>

    <!-- SF Symbols Style Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,0"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">

    <!-- iOS PWA Support -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MessFlow">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">

    <!-- iOS Specific Styles -->
    <style>
        /* Smooth scrolling for iOS */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent pull-to-refresh */
        body {
            overscroll-behavior-y: contain;
        }

        /* iOS safe areas */
        @supports (padding: env(safe-area-inset-top)) {
            .top-bar {
                padding-top: calc(12px + env(safe-area-inset-top));
            }

            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>

<body>

    <div id="app-root">

        <!-- Drawer Overlay -->
        <div class="drawer-overlay" id="drawer-overlay"></div>

        <!-- Navigation Drawer - iOS Slide-over -->
        <nav class="nav-drawer" id="nav-drawer">
            <!-- Profile Header - Clickable to Edit -->
            <div class="drawer-profile" onclick="openProfileModal()">
                <div class="profile-avatar" id="profile-avatar">AD</div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">Tap to set up</div>
                    <div class="profile-role" id="profile-phone">Add your details</div>
                </div>
                <span class="material-symbols-outlined"
                    style="color: var(--ios-text-tertiary); margin-left: auto;">chevron_right</span>
            </div>

            <div class="drawer-divider"></div>

            <a href="#" class="drawer-item active" onclick="navigate('home')">
                <span class="material-symbols-outlined">house</span>
                Entries
            </a>
            <a href="#" class="drawer-item" onclick="navigate('bill')">
                <span class="material-symbols-outlined">receipt_long</span>
                Generate Bill
            </a>
            <a href="#" class="drawer-item" onclick="navigate('pricing')">
                <span class="material-symbols-outlined">paid</span>
                Pricing Rules
            </a>
            <a href="#" class="drawer-item" onclick="navigate('presenty')" style="color: #34C759;">
                <span class="material-symbols-outlined">how_to_reg</span>
                Mess Presenty
            </a>

            <div class="drawer-divider"></div>

            <a href="#" class="drawer-item" onclick="navigate('reports')">
                <span class="material-symbols-outlined">bar_chart</span>
                Reports & Analytics
            </a>
            <a href="#" class="drawer-item" onclick="navigate('activity')">
                <span class="material-symbols-outlined">history</span>
                Activity Log
            </a>
            <a href="#" class="drawer-item" onclick="navigate('settings')">
                <span class="material-symbols-outlined">settings</span>
                Data & Settings
            </a>
        </nav>

        <!-- Top Search Pill -->
        <!-- Sticky Top Bar -->
        <div class="top-bar">
            <!-- Search Container (Visible on Home) -->
            <div class="search-pill" id="top-search-bar">
                <button class="icon-btn" onclick="toggleDrawer()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <input type="text" class="search-input" placeholder="Search entries..." id="search-input"
                    oninput="handleSearch(this.value)">

                <!-- Filter Trigger -->
                <button class="icon-btn" onclick="openSearchFilterModal()"
                    style="margin-right:4px; color:var(--md-sys-color-on-surface-variant);">
                    <span class="material-symbols-outlined">tune</span>
                </button>

                <div class="avatar" id="user-avatar" onclick="openProfileModal()" style="cursor: pointer;">AD</div>
            </div>

            <!-- Page Header (Visible on other pages) -->
            <div class="page-header" id="top-page-header" style="display:none;">
                <button class="icon-btn" onclick="toggleDrawer()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="page-title" id="page-title-text">Section Name</div>
            </div>

            <!-- Filter Chips Row (Google Style) -->
            <div class="filter-chips-row" id="filter-chips-row">
                <!-- Chips injected by JS -->
            </div>

            <!-- Global Loader Progress (Hidden by default) -->
            <div id="global-loader"
                style="display:none; position:absolute; bottom:-4px; left:0; width:100%; height:4px; background:var(--md-sys-color-surface-variant); overflow:hidden;">
                <div class="loader-bar"></div>
            </div>
        </div>

        <!-- Full Screen Overlay Loader for Blocking Actions -->
        <div id="full-screen-loader"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background:rgba(0,0,0,0.3); align-items:center; justify-content:center; flex-direction:column;">
            <div class="spinner"></div>
            <div id="loader-text"
                style="margin-top:16px; color:white; font-weight:500; text-shadow:0 1px 2px rgba(0,0,0,0.5);">
                Processing...</div>
        </div>

        <!-- Main Content -->
        <main class="content" id="main-content">

            <!-- View: Home -->
            <div id="view-home" class="view-section active">

                <!-- Quick Stats Card -->
                <div class="card stats-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:12px; font-weight:500; opacity:0.8; text-transform:uppercase;">This
                                Month</div>
                            <div style="font-size:28px; font-weight:bold; margin-top:4px;" id="stats-month-amount">â‚¹0
                            </div>
                            <div style="font-size:12px; opacity:0.8; margin-top:2px;" id="stats-month-count">0 Tiffins
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; font-weight:500; opacity:0.8; text-transform:uppercase;">Today
                            </div>
                            <div style="font-size:24px; font-weight:bold; margin-top:4px;" id="stats-today-total">0
                            </div>
                            <div style="font-size:12px; opacity:0.8;" id="stats-today-date">-</div>
                        </div>
                    </div>
                </div>

                <div class="section-title">TODAY</div>
                <div id="entries-list-today">
                    <div class="mail-item" style="opacity: 0.5; justify-content: center;">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="section-title">HISTORY</div>
                <div id="entries-list-week">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- View: Bill Generation -->
            <div id="view-bill" class="view-section">
                <div class="section-title">BILL GENERATION</div>

                <div style="padding: 16px 0;">
                    <!-- Filter Type Selection -->
                    <div class="input-group"
                        style="background: var(--md-sys-color-surface-container); border-radius: 8px; margin-bottom: 12px;">
                        <label
                            style="font-size: 12px; font-weight: 500; color: var(--md-sys-color-primary); padding: 8px 12px 0;">Select
                            Period</label>
                        <select class="m3-input" id="bill-filter-type" style="padding-top: 8px;"
                            onchange="toggleBillDateInputs()">
                            <option value="month">By Month</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                    </div>

                    <!-- Month Dropdown (default) -->
                    <div id="bill-month-container" class="input-group"
                        style="background: var(--md-sys-color-surface-container); border-radius: 8px;">
                        <select class="m3-input" id="bill-month-select" style="padding-top: 16px;">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Custom Date Range (hidden by default) -->
                    <div id="bill-custom-container" style="display: none;">
                        <div class="input-group"
                            style="background: var(--md-sys-color-surface-container); border-radius: 8px; margin-bottom: 12px;">
                            <label class="floating-label"
                                style="transform: translateY(-12px) scale(0.75); color: var(--md-sys-color-primary);">Start
                                Date</label>
                            <input type="date" class="m3-input" id="bill-start-date" style="padding-top: 16px;">
                        </div>
                        <div class="input-group"
                            style="background: var(--md-sys-color-surface-container); border-radius: 8px;">
                            <label class="floating-label"
                                style="transform: translateY(-12px) scale(0.75); color: var(--md-sys-color-primary);">End
                                Date</label>
                            <input type="date" class="m3-input" id="bill-end-date" style="padding-top: 16px;">
                        </div>
                    </div>

                    <button class="btn-filled" style="margin-top: 16px;" onclick="generateBillPreview()">
                        <span class="material-symbols-outlined">receipt</span>
                        Generate Bill
                    </button>
                </div>

                <div id="bill-card"
                    style="display:none; background: #FFFFFF; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-top: 16px;">

                    <!-- Header -->
                    <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                        <h3 style="margin:0; font-size: 18px; color: #000000; font-weight: 600;">Bill Summary</h3>
                        <span id="bill-period-display" style="color: #8E8E93; font-size: 14px;"></span>
                    </div>

                    <!-- iOS Grouped List Style -->
                    <div style="background: #F2F2F7; border-radius: 12px; overflow: hidden;">
                        <!-- Morning Row -->
                        <div
                            style="display:flex; justify-content:space-between; padding: 14px 16px; border-bottom: 1px solid rgba(60,60,67,0.1);">
                            <span style="font-size: 16px; color: #000000;">Morning</span>
                            <span id="bill-morning-count"
                                style="font-size: 16px; font-weight: 600; color: #000000;">0</span>
                        </div>
                        <!-- Evening Row -->
                        <div
                            style="display:flex; justify-content:space-between; padding: 14px 16px; border-bottom: 1px solid rgba(60,60,67,0.1);">
                            <span style="font-size: 16px; color: #000000;">Evening</span>
                            <span id="bill-evening-count"
                                style="font-size: 16px; font-weight: 600; color: #000000;">0</span>
                        </div>
                        <!-- Total Tiffins Row -->
                        <div
                            style="display:flex; justify-content:space-between; padding: 14px 16px; background: rgba(0,122,255,0.08);">
                            <span style="font-size: 16px; color: #007AFF; font-weight: 600;">Total Tiffins</span>
                            <span id="bill-total-tiffins"
                                style="font-size: 16px; font-weight: 700; color: #007AFF;">0</span>
                        </div>
                    </div>

                    <!-- Grand Total -->
                    <div
                        style="display:flex; justify-content:space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(60,60,67,0.12);">
                        <span style="font-weight: 600; font-size: 17px; color: #000000;">Grand Total</span>
                        <span id="bill-total-amount"
                            style="font-size: 28px; font-weight: 700; color: #34C759;">â‚¹0</span>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                        <button class="btn-text"
                            style="width:100%; border:1px solid #007AFF; border-radius: 10px; padding: 12px; color: #007AFF; background: #FFFFFF;"
                            onclick="printBill()">
                            <span class="material-symbols-outlined"
                                style="vertical-align: middle; font-size: 18px; margin-right: 8px;">print</span>
                            Print / PDF
                        </button>
                        <button class="btn-text"
                            style="width:100%; border:1px solid #007AFF; border-radius: 10px; padding: 12px; color: #007AFF; background: #FFFFFF;"
                            onclick="exportBillExcel()">
                            <span class="material-symbols-outlined"
                                style="vertical-align: middle; font-size: 18px; margin-right: 8px;">table_view</span>
                            Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hidden Container for Printable Bill -->
            <div id="printable-bill-container" style="display:none;"></div>

            <!-- View: Reports & Analytics -->
            <div id="view-reports" class="view-section">
                <div class="section-title">REPORTS & ANALYTICS</div>

                <!-- Controls: Month & Export -->
                <div style="display:flex; gap:12px; margin-bottom:16px;">
                    <div class="input-group"
                        style="flex:1; margin-bottom:0; border-radius:8px; border:1px solid var(--md-sys-color-outline-variant); background:var(--md-sys-color-surface);">
                        <select id="report-month-select" class="m3-input" onchange="renderCharts()"
                            style="border:none; padding:12px;">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <button class="icon-btn" onclick="exportReportCSV()"
                        style="background:var(--md-sys-color-secondary-container); color:var(--md-sys-color-on-secondary-container); width:48px; height:48px; border-radius:8px;">
                        <span class="material-symbols-outlined">download</span>
                    </button>
                </div>

                <!-- Google Analytics Style Cards -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:24px;">
                    <!-- Card 1: Morning -->
                    <div class="card analytics-card">
                        <div class="analytics-label">Morning</div>
                        <div class="analytics-value" id="report-morning">0</div>
                        <div class="analytics-bar" style="background:#8e24aa;"></div>
                    </div>
                    <!-- Card 2: Evening -->
                    <div class="card analytics-card">
                        <div class="analytics-label">Evening</div>
                        <div class="analytics-value" id="report-evening">0</div>
                        <div class="analytics-bar" style="background:#5d4037;"></div>
                    </div>
                    <!-- Card 3: Total -->
                    <div class="card analytics-card">
                        <div class="analytics-label">Total Tiffins</div>
                        <div class="analytics-value" id="report-total">0</div>
                        <div class="analytics-bar" style="background:#b71c1c;"></div>
                    </div>
                    <!-- Card 4: Amount -->
                    <div class="card analytics-card">
                        <div class="analytics-label">Revenue</div>
                        <div class="analytics-value" id="report-amount">â‚¹0</div>
                        <div class="analytics-bar" style="background:#004d40;"></div>
                    </div>
                </div>

                <!-- AI Insight -->
                <div id="ai-insight-card" class="card"
                    style="margin-top:0; margin-bottom:24px; background:var(--md-sys-color-secondary-container); color:var(--md-sys-color-on-secondary-container); display:none;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                        <span class="material-symbols-outlined" style="font-size:18px;">auto_awesome</span>
                        <span style="font-size:12px; font-weight:600;">AI FORECAST</span>
                    </div>
                    <div id="ai-insight-text" style="font-size:14px;"></div>
                </div>

                <!-- Charts -->
                <div class="card" style="margin-top:0; padding:16px;">
                    <div style="font-size:14px; font-weight:500; margin-bottom:12px;">Daily Trend</div>
                    <canvas id="chart-trend"></canvas>
                </div>

                <div class="card" style="margin-top:16px; padding:16px;">
                    <div style="font-size:14px; font-weight:500; margin-bottom:12px;">Morning vs Evening</div>
                    <canvas id="chart-comparison"></canvas>
                </div>

                <div class="card" style="margin-top:16px; padding:16px;">
                    <div style="font-size:14px; font-weight:500; margin-bottom:12px;">Monthly History (Last 6 Months)
                    </div>
                    <canvas id="chart-history"></canvas>
                </div>
            </div>

            <!-- View: Pricing Rules -->
            <div id="view-pricing" class="view-section">
                <div class="section-title">PRICING RULES</div>
                <div id="pricing-list">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- View: Mess Presenty -->
            <div id="view-presenty" class="view-section">
                <div class="section-title">MESS ATTENDANCE</div>

                <!-- Date & Category Selector -->
                <div class="card" style="padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                        <input type="date" id="presenty-date" class="ios-date-input"
                            style="flex:1; padding: 12px; border-radius: 10px; border: 1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface); font-size: 16px;"
                            onchange="loadMessAttendance()">
                        <button class="icon-btn" onclick="loadMessAttendance()"
                            style="background: var(--md-sys-color-primary-container); border-radius: 10px; width: 44px; height: 44px;">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                    </div>

                    <!-- Category Toggle -->
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-mess-day" class="presenty-toggle active" onclick="setMessCategory('Mess Day')">
                            ðŸŒ… Mess Day
                        </button>
                        <button id="btn-mess-night" class="presenty-toggle" onclick="setMessCategory('Mess Night')">
                            ðŸŒ™ Mess Night
                        </button>
                    </div>
                </div>

                <!-- Mark as Verified Checkbox -->
                <div
                    style="margin-bottom: 12px; padding: 14px 16px; background: var(--md-sys-color-surface); border-radius: 12px; border: 1px solid var(--md-sys-color-outline-variant);">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="presenty-verified-checkbox" onchange="toggleMPVerification()"
                            style="width: 22px; height: 22px; accent-color: #34C759;">
                        <span style="font-size: 16px; font-weight: 500; color: var(--md-sys-color-on-surface);">
                            Mark <span id="presenty-category-label">Mess Day</span> as Verified
                        </span>
                    </label>
                </div>

                <!-- Fetch from Database Button (Only for past dates) -->
                <div id="presenty-fetch-container" style="margin-bottom: 12px; display: none;">
                    <button onclick="fetchMessFromDatabase()"
                        style="width:100%; padding: 14px 16px; border: 2px solid var(--md-sys-color-outline-variant); border-radius: 12px; background: var(--md-sys-color-surface); color: #007AFF; font-weight: 600; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span class="material-symbols-outlined" style="font-size: 20px;">cloud_download</span>
                        Fetch <span id="presenty-fetch-label">Mess Day</span> from Database
                    </button>
                    <div id="presenty-fetch-status"
                        style="text-align: center; margin-top: 8px; font-size: 13px; color: #34C759; display: none;">
                        âœ“ Data already loaded from database
                    </div>
                </div>

                <!-- Stats Pills -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <div
                        style="flex:1; padding: 12px; background: rgba(52, 199, 89, 0.15); border-radius: 10px; text-align: center;">
                        <span style="font-weight: 600; color: #34C759;">Present </span>
                        <span style="font-weight: 700; color: #34C759;" id="presenty-present">0</span>
                    </div>
                    <div
                        style="flex:1; padding: 12px; background: rgba(255, 59, 48, 0.15); border-radius: 10px; text-align: center;">
                        <span style="font-weight: 600; color: #FF3B30;">Absent </span>
                        <span style="font-weight: 700; color: #FF3B30;" id="presenty-absent">0</span>
                    </div>
                    <div
                        style="flex:1; padding: 12px; background: rgba(255, 149, 0, 0.15); border-radius: 10px; text-align: center;">
                        <span style="font-weight: 600; color: #FF9500;">Leave </span>
                        <span style="font-weight: 700; color: #FF9500;" id="presenty-leave">0</span>
                    </div>
                </div>

                <!-- Search Bar -->
                <div style="margin-bottom: 12px;">
                    <div
                        style="display: flex; gap: 8px; align-items: center; background: var(--md-sys-color-surface); padding: 10px 14px; border-radius: 12px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <span class="material-symbols-outlined"
                            style="color: var(--md-sys-color-on-surface-variant); font-size: 20px;">search</span>
                        <input type="text" id="presenty-search" placeholder="Search students..."
                            style="flex:1; border:none; background:transparent; font-size:16px; outline:none; color: var(--md-sys-color-on-surface);"
                            oninput="filterMPStudents(this.value)">
                    </div>
                </div>

                <!-- Mark All Present Button -->
                <div style="margin-bottom: 12px;">
                    <button onclick="markAllMPPresent()"
                        style="width:100%; padding: 12px; border: none; border-radius: 10px; background: rgba(52, 199, 89, 0.15); color: #34C759; font-weight: 600; font-size: 14px; cursor: pointer;">
                        âœ“ Mark All Present
                    </button>
                </div>

                <!-- Students Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div
                        style="font-size: 13px; font-weight: 600; color: var(--md-sys-color-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">
                        STUDENTS</div>
                    <div style="font-size: 13px; color: var(--md-sys-color-on-surface-variant);"
                        id="presenty-total-count">0 total</div>
                </div>

                <!-- Student List -->
                <div id="presenty-student-list" style="padding-bottom: 100px;">
                    <div style="text-align:center; padding:40px; color:var(--md-sys-color-on-surface-variant);">
                        <span class="material-symbols-outlined" style="font-size:48px; opacity:0.5;">how_to_reg</span>
                        <div style="margin-top:12px;">Select date to load students</div>
                    </div>
                </div>

                <!-- Sync Button (Only enabled when verified) -->
                <div id="presenty-sync-bar"
                    style="position:fixed; bottom:20px; left:0; right:0; padding:16px; background: linear-gradient(transparent, var(--md-sys-color-background)); z-index:10; display:none;">
                    <button id="presenty-sync-btn" class="btn-filled" style="width:100%; padding:16px; font-size:16px;"
                        onclick="syncMessAttendance()" disabled>
                        <span class="material-symbols-outlined" style="margin-right:8px;">cloud_upload</span>
                        Sync Attendance
                    </button>
                </div>
            </div>

            <!-- View: Activity Log -->
            <div id="view-activity" class="view-section">
                <div class="section-title">ACTIVITY LOG</div>
                <div id="activity-list">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- View: Settings / Data -->
            <div id="view-settings" class="view-section">
                <div class="section-title">DATA MANAGEMENT</div>

                <div class="mail-item" onclick="exportData()">
                    <div class="mail-avatar"
                        style="background:var(--md-sys-color-secondary-container); color:var(--md-sys-color-on-secondary-container);">
                        <span class="material-symbols-outlined">download</span>
                    </div>
                    <div class="mail-content">
                        <div class="mail-header">
                            <span class="mail-sender">Backup Data</span>
                        </div>
                        <div class="mail-snippet">Download all entries as JSON</div>
                    </div>
                </div>

                <div class="mail-item" onclick="triggerImport()">
                    <div class="mail-avatar"
                        style="background:var(--md-sys-color-secondary-container); color:var(--md-sys-color-on-secondary-container);">
                        <span class="material-symbols-outlined">upload</span>
                    </div>
                    <div class="mail-content">
                        <div class="mail-header">
                            <span class="mail-sender">Restore Data</span>
                        </div>
                        <div class="mail-snippet">Import entries from JSON backup</div>
                    </div>
                </div>

                <input type="file" id="import-file" style="display:none;" onchange="importData(this)">

                <div class="mail-item" onclick="clearAllData()">
                    <div class="mail-avatar" style="background:#fce8e6; color:#c5221f;">
                        <span class="material-symbols-outlined">delete_forever</span>
                    </div>
                    <div class="mail-content">
                        <div class="mail-header">
                            <span class="mail-sender">Clear All Data</span>
                        </div>
                        <div class="mail-snippet" style="color:#c5221f;">Permanently delete all entries</div>
                    </div>
                </div>
            </div>

        </main>

        <!-- FAB (Add Entry/Rule) -->
        <button class="fab" id="fab-add" onclick="handleFabClick()">
            <span class="material-symbols-outlined fab-icon">edit</span>
            Compose
        </button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navigate('home')">
                <div class="nav-icon-container">
                    <span class="material-symbols-outlined">mail</span>
                </div>
                <span class="nav-label">Entries</span>
            </div>
            <div class="nav-item" onclick="navigate('bill')">
                <div class="nav-icon-container">
                    <span class="material-symbols-outlined">receipt_long</span>
                </div>
                <span class="nav-label">Bill</span>
            </div>
            <div class="nav-item" onclick="navigate('reports')">
                <div class="nav-icon-container">
                    <span class="material-symbols-outlined">analytics</span>
                </div>
                <span class="nav-label">Reports</span>
            </div>
        </nav>

        <!-- Add Entry Modal - iOS Bottom Sheet -->
        <div class="modal" id="entry-modal">
            <div class="modal-content ios-bottom-sheet">
                <!-- iOS Drag Handle -->
                <div class="sheet-handle"></div>

                <h3 class="modal-title" id="modal-title">New Entry</h3>

                <!-- Date Picker - iOS Style -->
                <div class="ios-date-picker">
                    <span class="material-symbols-outlined">calendar_today</span>
                    <input type="date" class="ios-date-input" id="new-date">
                </div>

                <!-- Morning Stepper -->
                <div class="ios-stepper-group">
                    <div class="stepper-label">
                        <span class="material-symbols-outlined" style="color: #FF9500;">wb_sunny</span>
                        <span>Morning Tiffins</span>
                    </div>
                    <div class="ios-stepper">
                        <button type="button" class="stepper-btn" onclick="stepValue('new-morning', -1)">
                            <span class="material-symbols-outlined">remove</span>
                        </button>
                        <input type="number" class="stepper-value" id="new-morning" value="0" min="0"
                            oninput="updateEntryTotalPreview()">
                        <button type="button" class="stepper-btn" onclick="stepValue('new-morning', 1)">
                            <span class="material-symbols-outlined">add</span>
                        </button>
                    </div>
                </div>

                <!-- Evening Stepper -->
                <div class="ios-stepper-group">
                    <div class="stepper-label">
                        <span class="material-symbols-outlined" style="color: #5856D6;">dark_mode</span>
                        <span>Evening Tiffins</span>
                    </div>
                    <div class="ios-stepper">
                        <button type="button" class="stepper-btn" onclick="stepValue('new-evening', -1)">
                            <span class="material-symbols-outlined">remove</span>
                        </button>
                        <input type="number" class="stepper-value" id="new-evening" value="0" min="0"
                            oninput="updateEntryTotalPreview()">
                        <button type="button" class="stepper-btn" onclick="stepValue('new-evening', 1)">
                            <span class="material-symbols-outlined">add</span>
                        </button>
                    </div>
                </div>

                <!-- Total Preview -->
                <div class="total-preview">
                    <span>Total:</span>
                    <span id="entry-total-preview">0 Tiffins</span>
                </div>

                <!-- Delete Button (hidden for new entries) -->
                <button class="btn-delete-full" id="delete-entry-btn" onclick="deleteEntry()" style="display: none;">
                    <span class="material-symbols-outlined">delete</span>
                    Delete Entry
                </button>

                <!-- Action Buttons -->
                <div class="ios-sheet-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-save-full" onclick="saveEntry()">
                        <span class="material-symbols-outlined">check</span>
                        Save Entry
                    </button>
                </div>
            </div>
        </div>

        <!-- Entry Details Modal (Edit/Delete) -->
        <div class="modal" id="details-modal">
            <div class="modal-content">
                <input type="hidden" id="detail-id"> <!-- Hidden ID -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 class="modal-title" id="detail-date" style="margin:0;">-</h3>
                    <div style="background:var(--md-sys-color-primary-container); color:var(--md-sys-color-on-primary-container); padding:4px 12px; border-radius:12px; font-weight:bold;"
                        id="detail-total">0</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px;">
                    <div class="detail-stat-box">
                        <span style="display:block; font-size:14px; opacity:0.7; margin-bottom:4px;">Morning</span>
                        <span style="font-size:24px; font-weight:500;" id="detail-morning">0</span>
                    </div>
                    <div class="detail-stat-box">
                        <span style="display:block; font-size:14px; opacity:0.7; margin-bottom:4px;">Evening</span>
                        <span style="font-size:24px; font-weight:500;" id="detail-evening">0</span>
                    </div>
                </div>

                <div style="margin-bottom:24px; text-align:center;">
                    <span style="font-size:16px;">Total Amount:</span>
                    <span style="font-size:24px; font-weight:bold; color:var(--md-sys-color-primary); margin-left:8px;"
                        id="detail-amount">â‚¹0</span>
                    <!-- Actions: Delete (Left), Actions (Right) -->
                    <div class="modal-actions"
                        style="justify-content: space-between; align-items: center; margin-top: 24px;">
                        <!-- Delete Button (Icon Only or Icon+Text Red) -->
                        <button class="btn-text btn-delete" onclick="deleteEntry()"
                            style="padding:0 12px; display:inline-flex; align-items:center;">
                            <span class="material-symbols-outlined"
                                style="font-size:18px; margin-right:6px;">delete</span>
                            <span style="font-size:14px; font-weight:500;">Delete</span>
                        </button>

                        <div style="display:flex; gap:8px;">
                            <button class="btn-text" onclick="closeModal()"
                                style="color:var(--md-sys-color-on-surface-variant); padding:0 12px;">Close</button>
                            <button class="btn-text" onclick="editEntry()"
                                style="background:var(--md-sys-color-primary-container); color:var(--md-sys-color-on-primary-container); padding:10px 20px; display:inline-flex; align-items:center; justify-content:center;">
                                <span class="material-symbols-outlined"
                                    style="font-size:20px; margin-right:6px;">edit</span>
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Pricing Rule Modal -->
        <div class="modal" id="pricing-modal">
            <div class="modal-content">
                <input type="hidden" id="price-id">
                <h3 class="modal-title">New Pricing Rule</h3>

                <div class="input-group">
                    <input type="date" class="m3-input" id="price-start" placeholder=" ">
                    <label class="m3-label">Start Date</label>
                </div>
                <div class="input-group">
                    <input type="date" class="m3-input" id="price-end" placeholder=" ">
                    <label class="m3-label">End Date (Optional)</label>
                </div>

                <div class="input-group">
                    <input type="number" class="m3-input" id="price-morning" placeholder=" " value="46">
                    <label class="m3-label">Morning Rate (â‚¹)</label>
                </div>

                <div class="input-group">
                    <input type="number" class="m3-input" id="price-evening" placeholder=" " value="46">
                    <label class="m3-label">Evening Rate (â‚¹)</label>
                </div>

                <div class="modal-actions">
                    <button class="btn-text" onclick="closeModal()">Cancel</button>
                    <button class="btn-text" onclick="savePricingRule()">Save Rule</button>
                </div>
            </div>
        </div>

        <!-- Profile Edit Modal -->
        <div class="modal" id="profile-modal">
            <div class="modal-content ios-bottom-sheet">
                <div class="sheet-handle"></div>

                <h3 class="modal-title">My Profile</h3>

                <!-- Name Input -->
                <div class="ios-input-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-profile-name" placeholder="Enter your name" class="ios-input">
                </div>

                <!-- Phone Input -->
                <div class="ios-input-group">
                    <label>Phone Number</label>
                    <input type="tel" id="edit-profile-phone" placeholder="Enter phone number" class="ios-input">
                </div>

                <!-- City Input -->
                <div class="ios-input-group">
                    <label>City</label>
                    <input type="text" id="edit-profile-city" placeholder="Enter your city" class="ios-input">
                </div>

                <!-- Pincode Input -->
                <div class="ios-input-group">
                    <label>Pincode</label>
                    <input type="text" id="edit-profile-pincode" placeholder="Enter pincode" class="ios-input"
                        maxlength="6">
                </div>

                <!-- Email Input -->
                <div class="ios-input-group">
                    <label>Email ID</label>
                    <input type="email" id="edit-profile-email" placeholder="Enter email address" class="ios-input">
                </div>

                <!-- Action Buttons -->
                <div class="ios-sheet-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-save-full" onclick="saveProfile()">
                        <span class="material-symbols-outlined">check</span>
                        Save Profile
                    </button>
                </div>
            </div>

        </div>

        <!-- Advanced Filter Modal -->
        <div class="modal" id="search-filter-modal">
            <div class="modal-content">
                <h3 class="modal-title" style="margin-top:0; margin-bottom:12px; font-size:18px;">Search Filters</h3>

                <!-- Filter Sections -->
                <div class="filter-section">
                    <label>Filter By</label>
                    <div class="chip-group-select">
                        <button class="filter-chip-option active" data-type="all"
                            onclick="setFilterType('all')">All</button>
                        <button class="filter-chip-option" data-type="date"
                            onclick="setFilterType('date')">Date</button>
                        <button class="filter-chip-option" data-type="month"
                            onclick="setFilterType('month')">Month</button>
                        <button class="filter-chip-option" data-type="year"
                            onclick="setFilterType('year')">Year</button>
                    </div>
                </div>

                <!-- Specific Filter Inputs -->
                <div id="filter-input-date" class="filter-input-group" style="display:none;">
                    <label>Select Date</label>
                    <input type="date" id="adv-filter-date">
                </div>

                <div id="filter-input-month" class="filter-input-group" style="display:none;">
                    <label>Select Month</label>
                    <input type="month" id="adv-filter-month">
                </div>

                <div id="filter-input-year" class="filter-input-group" style="display:none;">
                    <label>Select Year</label>
                    <div id="year-chips-container" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <!-- Years injected by JS -->
                    </div>
                </div>

                <div class="modal-actions" style="margin-top:20px;">
                    <button class="btn-text" onclick="closeModal()"
                        style="color:var(--md-sys-color-on-surface-variant);">Cancel</button>
                    <button class="btn-text" onclick="clearAllFilters()"
                        style="color:var(--md-sys-color-error);">Reset</button>
                    <button class="btn-text" onclick="applyAdvancedFilters()"
                        style="background:var(--md-sys-color-primary-container); color:var(--md-sys-color-on-primary-container);">
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Navigation -->


    </div> <!-- End app-root -->

    <!-- Printable Container (Hidden normally, Visible on Print) -->
    <div id="printable-bill-container" style="display:none;"></div>


    <!-- INSTANT CACHE LOADER - Pre-loads data from localStorage for super fast startup -->
    <script>
            (function () {
                window.MESS_CACHE = {
                    ENTRIES_KEY: 'mess_entries_v2',
                    PRICING_KEY: 'mess_pricing_v2',
                    entries: [],
                    pricing: [],
                    loaded: false
                };
                try {
                    var e = localStorage.getItem(window.MESS_CACHE.ENTRIES_KEY);
                    var p = localStorage.getItem(window.MESS_CACHE.PRICING_KEY);
                    if (e) { window.MESS_CACHE.entries = JSON.parse(e); window.MESS_CACHE.loaded = true; }
                    if (p) { window.MESS_CACHE.pricing = JSON.parse(p); }
                    console.log(' PRE-LOADED:', window.MESS_CACHE.entries.length, 'entries from cache!');
                } catch (err) { console.warn('Cache pre-load failed'); }

                window.saveToCache = function (entries, pricing) {
                    try {
                        if (entries) localStorage.setItem(window.MESS_CACHE.ENTRIES_KEY, JSON.stringify(entries));
                        if (pricing) localStorage.setItem(window.MESS_CACHE.PRICING_KEY, JSON.stringify(pricing));
                    } catch (ex) { }
                };
            })();
    </script>

    <!-- Main App Script -->
    <!-- INSTANT CACHE LOADER -->
    <script>
        (function () {
            window.MESS_CACHE = { ENTRIES_KEY: 'mess_entries_v2', PRICING_KEY: 'mess_pricing_v2', entries: [], pricing: [], loaded: false };
            try {
                var e = localStorage.getItem(window.MESS_CACHE.ENTRIES_KEY);
                var p = localStorage.getItem(window.MESS_CACHE.PRICING_KEY);
                if (e) { window.MESS_CACHE.entries = JSON.parse(e); window.MESS_CACHE.loaded = true; }
                if (p) { window.MESS_CACHE.pricing = JSON.parse(p); }
                console.log(' PRE-LOADED:', window.MESS_CACHE.entries.length, 'entries from cache!');
            } catch (err) { }
            window.saveToCache = function (entries, pricing) {
                try { if (entries) localStorage.setItem(window.MESS_CACHE.ENTRIES_KEY, JSON.stringify(entries)); if (pricing) localStorage.setItem(window.MESS_CACHE.PRICING_KEY, JSON.stringify(pricing)); } catch (ex) { }
            };
        })();
    </script>
    <script src="mobile.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('âŒ Service Worker registration failed:', error);
                    });
            });
        }
    </script>

</body>

</html>